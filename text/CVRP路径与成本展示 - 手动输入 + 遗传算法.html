<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CVRPè·¯å¾„ä¸æˆæœ¬å±•ç¤º - æ‰‹åŠ¨è¾“å…¥ + é—ä¼ ç®—æ³•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .left-panel, .right-panel {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196f3;
            color: #2196f3;
        }
        #canvas-left, #canvas-right {
            border: 1px solid #333;
            background: #fafafa;
            margin: 10px 0;
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .canvas-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        
        .canvas-control-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .canvas-control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .canvas-control-btn:active {
            transform: scale(0.95);
        }
        
        .canvas-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            border: 1px solid #ddd;
        }
        #inputArea {
            margin-bottom: 15px;
        }
        #cost-left, #cost-right {
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 4px;
        }
        table {
            border-collapse: collapse;
            margin-bottom: 10px;
            width: 100%;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 6px 10px;
            text-align: center;
        }
        .over-capacity {
            background: #ffcccc;
        }
        .customer-grid {
            display: flex;
            gap: 4px;
            margin: 4px 0;
            flex-wrap: wrap;
        }
        .customer-cell {
            width: 28px;
            height: 28px;
            border: 1px solid #888;
            text-align: center;
            font-size: 14px;
            line-height: 28px;
            background: #fff;
            outline: none;
            border-radius: 4px;
            transition: border 0.2s;
        }
        .customer-cell:focus {
            border: 2px solid #2196f3;
        }
        .cell-invalid {
            background: #ffeaea;
            border-color: #e91e63;
        }
        .ga-controls {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .ga-controls label {
            margin-right: 10px;
            font-weight: bold;
        }
        .ga-controls input, .ga-controls select {
            margin-right: 15px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .ga-controls button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .ga-controls button:hover {
            background: #45a049;
        }
        .ga-controls button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .import-button {
            background: #ff9800 !important;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        .import-button:hover:not(:disabled) {
            background: #f57c00 !important;
        }
        
        .import-button:disabled {
            background: #cccccc !important;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #4caf50;
            width: 0%;
            transition: width 0.3s ease;
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #1976d2; margin-bottom: 30px;">å¸¦å®¹é‡çº¦æŸçš„è½¦è¾†è·¯å¾„é—®é¢˜ï¼ˆCVRPï¼‰æ±‚è§£å™¨</h1>
    
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ï¼šæ‰‹åŠ¨è¾“å…¥ -->
        <div class="left-panel">
            <div class="panel-title">ğŸ“ æ‰‹åŠ¨è¾“å…¥æ±‚è§£</div>
            <div id="inputArea">
                <label for="vehicleNum">è¯·è¾“å…¥è½¦è¾†æ•°é‡ï¼š</label>
                <input type="number" id="vehicleNum" min="1" max="15" value="3" style="width:50px;">
                <button onclick="generateTable()">ç”Ÿæˆè½¦è¾†å®¢æˆ·åˆ†é…è¡¨</button>
                <div id="capacityInfo" style="margin:8px 0;"></div>
                <form id="routeForm" onsubmit="event.preventDefault(); drawCVRP();">
                    <div id="vehicleTableArea"></div>
                    <button type="submit" id="showBtn" style="display:none;">å±•ç¤ºè·¯å¾„ä¸æˆæœ¬</button>
                </form>
            </div>
            <div class="canvas-container">
                <canvas id="canvas-left" width="500" height="400"></canvas>
                <div class="canvas-controls">
                    <button class="canvas-control-btn" onclick="zoomIn('left')" title="æ”¾å¤§">ğŸ”+</button>
                    <button class="canvas-control-btn" onclick="zoomOut('left')" title="ç¼©å°">ğŸ”-</button>
                    <button class="canvas-control-btn" onclick="resetZoom('left')" title="é‡ç½®ç¼©æ”¾">ğŸ”„</button>
                </div>
                <div class="canvas-info" id="canvas-info-left">ç¼©æ”¾: 100% | æ‹–æ‹½æŸ¥çœ‹</div>
            </div>
            <div id="cost-left"></div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šé—ä¼ ç®—æ³• -->
        <div class="right-panel">
            <div class="panel-title">ğŸ§¬ é—ä¼ ç®—æ³•æ±‚è§£</div>
            <div class="ga-controls">
                <label for="gaVehicleNum">è½¦è¾†æ•°é‡:</label>
                <input type="number" id="gaVehicleNum" min="1" max="15" value="3" style="width:50px;">
                
                <label for="populationSize">ç§ç¾¤å¤§å°:</label>
                <input type="number" id="populationSize" min="20" max="200" value="50" style="width:50px;">
                
                <label for="generations">è¿­ä»£ä»£æ•°:</label>
                <input type="number" id="generations" min="10" max="500" value="100" style="width:50px;">
                
                <label for="mutationRate">å˜å¼‚ç‡:</label>
                <select id="mutationRate">
                    <option value="0.01">0.01</option>
                    <option value="0.05" selected>0.05</option>
                    <option value="0.1">0.1</option>
                    <option value="0.15">0.15</option>
                </select>
                
                <label for="maxRunTime">æœ€å¤§è¿è¡Œæ—¶é—´(ç§’):</label>
                <input type="number" id="maxRunTime" min="10" max="120" value="30" style="width:50px;">
                
                <br><br>
                <button onclick="runGeneticAlgorithm()" id="runGA">è¿è¡Œé—ä¼ ç®—æ³•</button>
                <button onclick="stopGeneticAlgorithm()" id="stopGA" disabled>åœæ­¢</button>
                <button onclick="resetGA()">é‡ç½®</button>
                <button onclick="importGASolution()" id="importBtn" disabled class="import-button">ğŸ“‹ å¯¼å…¥åˆ°å·¦ä¾§</button>
                <button onclick="testGeneticAlgorithm()" style="background: #ff5722; margin-left: 10px;">ğŸ§ª æµ‹è¯•ç®—æ³•</button>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- é—ä¼ ç®—æ³•è·¯å¾„æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="gaRoutesDisplay" style="margin: 15px 0; display: none;">
                <h4 style="margin: 5px 0; color: #1976d2; border-bottom: 1px solid #e0e0e0; padding-bottom: 5px;">ğŸ§¬ å½“å‰æœ€ä½³è·¯å¾„:</h4>
                <div id="gaRoutesInfo" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="currentGen">0</div>
                    <div class="stat-label">å½“å‰ä»£æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="bestCost">-</div>
                    <div class="stat-label">æœ€ä½³æˆæœ¬</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgCost">-</div>
                    <div class="stat-label">å¹³å‡æˆæœ¬</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="timeElapsed">0s</div>
                    <div class="stat-label">è¿è¡Œæ—¶é—´</div>
                </div>
            </div>
            
            <div class="canvas-container">
                <canvas id="canvas-right" width="500" height="400"></canvas>
                <div class="canvas-controls">
                    <button class="canvas-control-btn" onclick="zoomIn('right')" title="æ”¾å¤§">ğŸ”+</button>
                    <button class="canvas-control-btn" onclick="zoomOut('right')" title="ç¼©å°">ğŸ”-</button>
                    <button class="canvas-control-btn" onclick="resetZoom('right')" title="é‡ç½®ç¼©æ”¾">ğŸ”„</button>
                </div>
                <div class="canvas-info" id="canvas-info-right">ç¼©æ”¾: 100% | æ‹–æ‹½æŸ¥çœ‹</div>
            </div>
            <div id="cost-right"></div>
        </div>
    </div>

    <script>
        // å†…ç½®å®¢æˆ·ç‚¹æ•°æ®ï¼ˆåŒ…æ‹¬ä»“åº“å’Œ30ä¸ªå®¢æˆ·ç‚¹ï¼‰
        // å‡è®¾0å·ç‚¹ä¸ºä»“åº“
        // æ¯ä¸ªå®¢æˆ·æœ‰éœ€æ±‚ demand
        const customers = [
            {id: 0, x: 250, y: 200, name: "ä»“åº“", demand: 0},
            {id: 1, x: 100, y: 100, name: "å®¢æˆ·1", demand: 8},
            {id: 2, x: 150, y: 80,  name: "å®¢æˆ·2", demand: 12},
            {id: 3, x: 200, y: 60,  name: "å®¢æˆ·3", demand: 15},
            {id: 4, x: 300, y: 50,  name: "å®¢æˆ·4", demand: 10},
            {id: 5, x: 400, y: 70,  name: "å®¢æˆ·5", demand: 18},
            {id: 6, x: 450, y: 100, name: "å®¢æˆ·6", demand: 14},
            {id: 7, x: 500, y: 150, name: "å®¢æˆ·7", demand: 16},
            {id: 8, x: 480, y: 200, name: "å®¢æˆ·8", demand: 11},
            {id: 9, x: 420, y: 250, name: "å®¢æˆ·9", demand: 13},
            {id: 10, x: 350, y: 280, name: "å®¢æˆ·10", demand: 9},
            {id: 11, x: 280, y: 300, name: "å®¢æˆ·11", demand: 17},
            {id: 12, x: 200, y: 320, name: "å®¢æˆ·12", demand: 12},
            {id: 13, x: 150, y: 300, name: "å®¢æˆ·13", demand: 14},
            {id: 14, x: 100, y: 280, name: "å®¢æˆ·14", demand: 10},
            {id: 15, x: 80, y: 250, name: "å®¢æˆ·15", demand: 16},
            {id: 16, x: 90, y: 200, name: "å®¢æˆ·16", demand: 11},
            {id: 17, x: 120, y: 180, name: "å®¢æˆ·17", demand: 13},
            {id: 18, x: 180, y: 160, name: "å®¢æˆ·18", demand: 15},
            {id: 19, x: 220, y: 140, name: "å®¢æˆ·19", demand: 9},
            {id: 20, x: 320, y: 120, name: "å®¢æˆ·20", demand: 12},
            {id: 21, x: 380, y: 140, name: "å®¢æˆ·21", demand: 14},
            {id: 22, x: 440, y: 180, name: "å®¢æˆ·22", demand: 16},
            {id: 23, x: 460, y: 220, name: "å®¢æˆ·23", demand: 11},
            {id: 24, x: 400, y: 240, name: "å®¢æˆ·24", demand: 13},
            {id: 25, x: 320, y: 260, name: "å®¢æˆ·25", demand: 15},
            {id: 26, x: 240, y: 280, name: "å®¢æˆ·26", demand: 10},
            {id: 27, x: 180, y: 260, name: "å®¢æˆ·27", demand: 12},
            {id: 28, x: 140, y: 240, name: "å®¢æˆ·28", demand: 14},
            {id: 29, x: 110, y: 220, name: "å®¢æˆ·29", demand: 16},
            {id: 30, x: 130, y: 160, name: "å®¢æˆ·30", demand: 11}
        ];

        // è½¦è¾†å®¹é‡
        const vehicleCapacity = 50;

        // ç”»å¸ƒç¼©æ”¾å’Œæ‹–æ‹½ç›¸å…³å˜é‡
        const canvasStates = {
            left: { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0 },
            right: { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0 }
        };

        // é—ä¼ ç®—æ³•ç›¸å…³å˜é‡
        let gaRunning = false;
        let gaInterval = null;
        let startTime = 0;
        let currentGeneration = 0;
        let bestSolution = null;
        let bestCost = Infinity;
        let population = [];
        let populationSize = 50;
        let generations = 100;
        let mutationRate = 0.05;
        let maxRunTime = 30000; // æœ€å¤§è¿è¡Œæ—¶é—´30ç§’

        function getCustomerById(id) {
            return customers.find(c => c.id === id);
        }

        function distance(a, b) {
            return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
        }

        // ç”»å¸ƒç¼©æ”¾å’Œæ‹–æ‹½åŠŸèƒ½
        function zoomIn(canvasId) {
            const state = canvasStates[canvasId];
            state.scale = Math.min(state.scale * 1.2, 5); // æœ€å¤§æ”¾å¤§5å€
            updateCanvasTransform(canvasId);
        }

        function zoomOut(canvasId) {
            const state = canvasStates[canvasId];
            state.scale = Math.max(state.scale / 1.2, 0.2); // æœ€å°ç¼©å°åˆ°0.2å€
            updateCanvasTransform(canvasId);
        }

        function resetZoom(canvasId) {
            const state = canvasStates[canvasId];
            state.scale = 1;
            state.offsetX = 0;
            state.offsetY = 0;
            updateCanvasTransform(canvasId);
        }

        function updateCanvasTransform(canvasId) {
            const state = canvasStates[canvasId];
            const canvas = document.getElementById(`canvas-${canvasId}`);
            const ctx = canvas.getContext('2d');
            
            // æ›´æ–°ç”»å¸ƒå˜æ¢
            ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®å˜æ¢
            ctx.translate(state.offsetX, state.offsetY);
            ctx.scale(state.scale, state.scale);
            
            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            const infoElement = document.getElementById(`canvas-info-${canvasId}`);
            infoElement.textContent = `ç¼©æ”¾: ${Math.round(state.scale * 100)}% | æ‹–æ‹½æŸ¥çœ‹`;
            
            // é‡æ–°ç»˜åˆ¶
            if (canvasId === 'left') {
                drawCVRP();
            } else if (canvasId === 'right' && bestSolution) {
                drawGASolution(bestSolution);
            }
        }

        function setupCanvasInteraction(canvasId) {
            const canvas = document.getElementById(`canvas-${canvasId}`);
            const state = canvasStates[canvasId];
            
            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // è®¡ç®—ç¼©æ”¾ä¸­å¿ƒ
                const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(0.2, Math.min(5, state.scale * scaleFactor));
                
                if (newScale !== state.scale) {
                    // è°ƒæ•´åç§»ä»¥ä¿æŒé¼ æ ‡ä½ç½®ä¸å˜
                    state.offsetX = mouseX - (mouseX - state.offsetX) * (newScale / state.scale);
                    state.offsetY = mouseY - (mouseY - state.offsetY) * (newScale / state.scale);
                    state.scale = newScale;
                    updateCanvasTransform(canvasId);
                }
            });
            
            // é¼ æ ‡æ‹–æ‹½
            canvas.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // å·¦é”®
                    state.isDragging = true;
                    state.lastX = e.clientX;
                    state.lastY = e.clientY;
                    canvas.style.cursor = 'grabbing';
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (state.isDragging) {
                    const deltaX = e.clientX - state.lastX;
                    const deltaY = e.clientY - state.lastY;
                    
                    state.offsetX += deltaX;
                    state.offsetY += deltaY;
                    
                    state.lastX = e.clientX;
                    state.lastY = e.clientY;
                    
                    updateCanvasTransform(canvasId);
                }
            });
            
            canvas.addEventListener('mouseup', (e) => {
                if (e.button === 0) {
                    state.isDragging = false;
                    canvas.style.cursor = 'grab';
                }
            });
            
            canvas.addEventListener('mouseleave', () => {
                state.isDragging = false;
                canvas.style.cursor = 'grab';
            });
            
            // è®¾ç½®åˆå§‹å…‰æ ‡æ ·å¼
            canvas.style.cursor = 'grab';
        }

        // è®°å½•æ¯è¾†è½¦å½“å‰æ–¹æ ¼æ•°é‡
        let vehicleCellCounts = {};

        // ç”Ÿæˆæ¯è¾†è½¦çš„å®¢æˆ·è¾“å…¥æ–¹æ ¼
        function generateCustomerGrid(vehicleIdx, cellCount = 10) {
            let html = `<div class="customer-grid" id="customerGrid${vehicleIdx}">`;
            for (let i = 0; i < cellCount; i++) {
                html += `<input type="text" maxlength="2" class="customer-cell" id="cell_${vehicleIdx}_${i}" 
                    oninput="onCellInput(${vehicleIdx}, ${i})" 
                    onkeydown="onCellKeyDown(event, ${vehicleIdx}, ${i})"
                    autocomplete="off"
                >`;
            }
            html += '</div>';
            return html;
        }

        function generateTable() {
            const vehicleNum = parseInt(document.getElementById('vehicleNum').value);
            if (isNaN(vehicleNum) || vehicleNum < 1) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è½¦è¾†æ•°é‡ï¼");
                return;
            }
            
            // å±•ç¤ºå®¹é‡ä¿¡æ¯å’Œå®¢æˆ·éœ€æ±‚è¡¨æ ¼
            let capacityHtml = `<div style="margin: 15px 0;">
                <div style="margin-bottom: 10px; font-weight: bold; color: #1976d2;">
                    æ¯è¾†è½¦å®¹é‡é™åˆ¶ï¼š<span style="color: #f44336; font-size: 16px;">${vehicleCapacity}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 5px 0; color: #333; border-bottom: 1px solid #e0e0e0; padding-bottom: 5px;">
                        ğŸ“Š å®¢æˆ·éœ€æ±‚è¡¨
                    </h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead style="background: #f5f5f5; position: sticky; top: 0;">
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e3f2fd;">å®¢æˆ·ç¼–å·</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e3f2fd;">éœ€æ±‚æ•°é‡</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e3f2fd;">å®¢æˆ·ç¼–å·</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e3f2fd;">éœ€æ±‚æ•°é‡</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e3f2fd;">å®¢æˆ·ç¼–å·</th>
                                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center; background: #e3f2fd;">éœ€æ±‚æ•°é‡</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            // å°†å®¢æˆ·åˆ†æˆ3åˆ—æ˜¾ç¤º
            const customerRows = Math.ceil((customers.length - 1) / 3); // å‡å»ä»“åº“
            for (let row = 0; row < customerRows; row++) {
                capacityHtml += '<tr>';
                for (let col = 0; col < 3; col++) {
                    const customerIndex = row + col * customerRows + 1;
                    if (customerIndex < customers.length) {
                        const customer = customers[customerIndex];
                        const demandClass = customer.demand > vehicleCapacity / 2 ? 'high-demand' : 'normal-demand';
                        capacityHtml += `
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; color: #1976d2;">
                                ${customer.id}
                            </td>
                            <td style="border: 1px solid #ddd; padding: 6px; text-align: center; background: ${customer.demand > vehicleCapacity / 2 ? '#fff3e0' : '#f1f8e9'};">
                                <span class="${demandClass}" style="font-weight: bold; color: ${customer.demand > vehicleCapacity / 2 ? '#f57c00' : '#388e3c'};">
                                    ${customer.demand}
                                </span>
                            </td>`;
                    } else {
                        capacityHtml += '<td style="border: 1px solid #ddd; padding: 6px;"></td><td style="border: 1px solid #ddd; padding: 6px;"></td>';
                    }
                }
                capacityHtml += '</tr>';
            }
            
            capacityHtml += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #666;">
                        ğŸ’¡ æç¤ºï¼šéœ€æ±‚æ•°é‡è¶…è¿‡å®¹é‡ä¸€åŠçš„å®¢æˆ·ç”¨æ©™è‰²æ ‡æ³¨ï¼Œå»ºè®®åˆç†åˆ†é…
                    </div>
                </div>
            </div>`;
            
            document.getElementById('capacityInfo').innerHTML = capacityHtml;

            // åˆå§‹åŒ–æ¯è¾†è½¦çš„æ–¹æ ¼æ•°é‡
            vehicleCellCounts = {};
            let html = '<table><tr><th>è½¦è¾†ç¼–å·</th><th>æœåŠ¡å®¢æˆ·ç¼–å·ï¼ˆæ¯æ ¼å¡«ä¸€ä¸ªç¼–å·ï¼‰</th><th>æœ¬è½¦æ€»éœ€æ±‚</th></tr>';
            for (let i = 0; i < vehicleNum; i++) {
                vehicleCellCounts[i] = 10;
                html += `<tr>
                    <td>è½¦è¾†${i+1}</td>
                    <td>${generateCustomerGrid(i, vehicleCellCounts[i])}</td>
                    <td id="demand${i}">0</td>
                </tr>`;
            }
            html += '</table>';
            document.getElementById('vehicleTableArea').innerHTML = html;
            document.getElementById('showBtn').style.display = 'inline-block';

            // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼Œå®æ—¶è®¡ç®—éœ€æ±‚
            for (let i = 0; i < vehicleNum; i++) {
                updateDemand(i);
            }
        }

        // è¾“å…¥æ—¶è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæ ¼å­ï¼Œå¹¶åŠ¨æ€å¢åŠ æ–¹æ ¼
        function onCellInput(vehicleIdx, cellIdx) {
            // åªå…è®¸è¾“å…¥1-30çš„æ•°å­—
            const cell = document.getElementById(`cell_${vehicleIdx}_${cellIdx}`);
            let val = cell.value.replace(/[^0-9]/g, '');
            if (val.length > 2) val = val.substring(0, 2);
            cell.value = val;
            // æ£€æŸ¥æœ‰æ•ˆæ€§
            if (val !== "" && (parseInt(val) === 0 || !getCustomerById(parseInt(val)) || parseInt(val) === 0)) {
                cell.classList.add('cell-invalid');
            } else {
                cell.classList.remove('cell-invalid');
            }
            // è·³åˆ°ä¸‹ä¸€ä¸ªæ ¼å­
            if (val !== "") {
                // å¦‚æœæ˜¯æœ€åä¸€ä¸ªæ ¼å­ä¸”è¢«å¡«ä¸Šï¼ŒåŠ¨æ€å¢åŠ ä¸€ä¸ªæ ¼å­
                if (cellIdx === vehicleCellCounts[vehicleIdx] - 1) {
                    // å¢åŠ ä¸€ä¸ªæ ¼å­
                    vehicleCellCounts[vehicleIdx]++;
                    const gridDiv = document.getElementById(`customerGrid${vehicleIdx}`);
                    const newInput = document.createElement('input');
                    newInput.type = "text";
                    newInput.maxLength = 2;
                    newInput.className = "customer-cell";
                    newInput.id = `cell_${vehicleIdx}_${cellIdx+1}`;
                    newInput.setAttribute("oninput", `onCellInput(${vehicleIdx}, ${cellIdx+1})`);
                    newInput.setAttribute("onkeydown", `onCellKeyDown(event, ${vehicleIdx}, ${cellIdx+1})`);
                    newInput.setAttribute("autocomplete", "off");
                    gridDiv.appendChild(newInput);
                }
                // è·³åˆ°ä¸‹ä¸€ä¸ªæ ¼å­
                const nextCell = document.getElementById(`cell_${vehicleIdx}_${cellIdx+1}`);
                if (nextCell) nextCell.focus();
            }
            updateDemand(vehicleIdx);
        }

        // æ”¯æŒç”¨é€€æ ¼é”®å›åˆ°ä¸Šä¸€ä¸ªæ ¼å­
        function onCellKeyDown(e, vehicleIdx, cellIdx) {
            const cell = document.getElementById(`cell_${vehicleIdx}_${cellIdx}`);
            if (e.key === "Backspace" && cell.value === "" && cellIdx > 0) {
                document.getElementById(`cell_${vehicleIdx}_${cellIdx-1}`).focus();
            }
        }

        // è·å–æ¯è¾†è½¦çš„å®¢æˆ·ç¼–å·æ•°ç»„
        function getVehicleRoute(vehicleIdx) {
            let ids = [];
            const count = vehicleCellCounts[vehicleIdx] || 10;
            for (let i = 0; i < count; i++) {
                let cell = document.getElementById(`cell_${vehicleIdx}_${i}`);
                if (!cell) continue;
                let val = cell.value.trim();
                if (val !== "") {
                    let id = parseInt(val);
                    if (!isNaN(id)) ids.push(id);
                }
            }
            return ids;
        }

        function updateDemand(idx) {
            const ids = getVehicleRoute(idx);
            let sum = 0;
            for (let id of ids) {
                const c = getCustomerById(id);
                if (c && c.id !== 0) sum += c.demand;
            }
            const td = document.getElementById(`demand${idx}`);
            td.innerText = sum;
            if (sum > vehicleCapacity) {
                td.classList.add('over-capacity');
            } else {
                td.classList.remove('over-capacity');
            }
        }

        function drawCVRP() {
            const vehicleNum = parseInt(document.getElementById('vehicleNum').value);
            let allAssigned = [];
            let routes = [];
            let overCapacity = false;
            for (let i = 0; i < vehicleNum; i++) {
                const ids = getVehicleRoute(i);
                // æ£€æŸ¥å®¢æˆ·ç‚¹ç¼–å·æœ‰æ•ˆæ€§
                for (let id of ids) {
                    if (!getCustomerById(id) || id === 0) {
                        alert(`è½¦è¾†${i+1}çš„å®¢æˆ·ç¼–å·æœ‰è¯¯ï¼Œæˆ–åŒ…å«ä»“åº“ç¼–å·0ï¼Œè¯·é‡æ–°è¾“å…¥ï¼`);
                        return;
                    }
                }
                // æ£€æŸ¥é‡å¤åˆ†é…
                for (let id of ids) {
                    if (allAssigned.includes(id)) {
                        alert(`å®¢æˆ·ç‚¹${id}è¢«å¤šè¾†è½¦åˆ†é…ï¼Œè¯·æ£€æŸ¥ï¼`);
                        return;
                    }
                    allAssigned.push(id);
                }
                // æ£€æŸ¥å®¹é‡
                let sum = 0;
                for (let id of ids) {
                    const c = getCustomerById(id);
                    if (c) sum += c.demand;
                }
                if (sum > vehicleCapacity) {
                    overCapacity = true;
                }
                routes.push(ids);
            }
            // æ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·æœªåˆ†é…
            const allCustomerIds = customers.filter(c => c.id !== 0).map(c => c.id);
            for (let id of allCustomerIds) {
                if (!allAssigned.includes(id)) {
                    alert(`å®¢æˆ·ç‚¹${id}æœªè¢«åˆ†é…ï¼Œè¯·æ£€æŸ¥ï¼`);
                    return;
                }
            }

            // ç»˜åˆ¶
            const canvas = document.getElementById('canvas-left');
            const ctx = canvas.getContext('2d');
            
            // åº”ç”¨ç¼©æ”¾å’Œæ‹–æ‹½å˜æ¢
            const state = canvasStates.left;
            ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®å˜æ¢
            ctx.translate(state.offsetX, state.offsetY);
            ctx.scale(state.scale, state.scale);
            
            ctx.clearRect(-state.offsetX/state.scale, -state.offsetY/state.scale, canvas.width/state.scale, canvas.height/state.scale);

            // ç”»ç‚¹
            for (let c of customers) {
                ctx.beginPath();
                ctx.arc(c.x/1.2, c.y/1.2, 8, 0, 2 * Math.PI);
                ctx.fillStyle = c.id === 0 ? "#ff6600" : "#3399ff";
                ctx.fill();
                ctx.strokeStyle = "#333";
                ctx.stroke();
                ctx.font = "12px Arial";
                ctx.fillStyle = "#000";
                ctx.fillText(`${c.id}`, c.x/1.2 + 10, c.y/1.2 + 4);
            }

            // ç”»è·¯å¾„ï¼ˆæ¯è¾†è½¦ä¸€ç§é¢œè‰²ï¼‰
            const colors = ["#e91e63", "#2196f3", "#4caf50", "#ff9800", "#9c27b0", "#009688", "#795548", "#607d8b", "#f44336", "#3f51b5"];
            let totalCost = 0;
            for (let i = 0; i < routes.length; i++) {
                const route = routes[i];
                if (route.length === 0) continue;
                ctx.strokeStyle = colors[i % colors.length];
                ctx.lineWidth = 2;
                ctx.beginPath();
                // ä»“åº“å‡ºå‘
                let start = getCustomerById(0);
                ctx.moveTo(start.x/1.2, start.y/1.2);
                for (let id of route) {
                    let c = getCustomerById(id);
                    ctx.lineTo(c.x/1.2, c.y/1.2);
                }
                // å›åˆ°ä»“åº“
                ctx.lineTo(start.x/1.2, start.y/1.2);
                ctx.stroke();

                // è®¡ç®—æˆæœ¬
                let cost = 0;
                let prev = getCustomerById(0);
                for (let id of route) {
                    let c = getCustomerById(id);
                    cost += distance(prev, c);
                    prev = c;
                }
                cost += distance(prev, getCustomerById(0));
                totalCost += cost;

                // åœ¨è·¯å¾„ä¸­é—´æ ‡æ³¨è½¦è¾†ç¼–å·
                if (route.length > 0) {
                    let midIdx = Math.floor(route.length / 2);
                    let midC = getCustomerById(route[midIdx]);
                    ctx.font = "bold 14px Arial";
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fillText(`è½¦è¾†${i+1}`, midC.x/1.2 + 15, midC.y/1.2 - 10);
                }
            }

            // æ˜¾ç¤ºæˆæœ¬
            let costMsg = `æ€»è·¯å¾„æˆæœ¬ï¼š${totalCost.toFixed(2)}`;
            if (overCapacity) {
                costMsg += "ï¼ˆæœ‰è½¦è¾†è¶…å‡ºå®¹é‡é™åˆ¶ï¼Œè¯·è°ƒæ•´ï¼ï¼‰";
            }
            document.getElementById('cost-left').innerText = costMsg;
        }

        // ========== é—ä¼ ç®—æ³•éƒ¨åˆ† ==========
        
        // ç”Ÿæˆéšæœºè§£
        function generateRandomSolution(vehicleNum) {
            const customerIds = customers.filter(c => c.id !== 0).map(c => c.id);
            const shuffled = [...customerIds].sort(() => Math.random() - 0.5);
            
            // åˆ›å»ºè½¦è¾†æ•°ç»„
            const solution = Array(vehicleNum).fill().map(() => []);
            
            // æŒ‰å®¹é‡çº¦æŸåˆ†é…å®¢æˆ·ï¼Œä½†å…è®¸è¶…å‡ºå®¹é‡
            for (let customerId of shuffled) {
                const customer = getCustomerById(customerId);
                let assigned = false;
                
                // å°è¯•æ‰¾åˆ°å®¹é‡è¶³å¤Ÿçš„è½¦è¾†
                for (let attempt = 0; attempt < vehicleNum; attempt++) {
                    const targetVehicle = attempt;
                    const currentDemand = solution[targetVehicle].reduce((sum, id) => sum + getCustomerById(id).demand, 0);
                    
                    if (currentDemand + customer.demand <= vehicleCapacity) {
                        solution[targetVehicle].push(customerId);
                        assigned = true;
                        break;
                    }
                }
                
                // å¦‚æœæ‰€æœ‰è½¦è¾†éƒ½å®¹é‡ä¸è¶³ï¼Œåˆ†é…ç»™ç¬¬ä¸€ä¸ªè½¦è¾†ï¼ˆå…è®¸è¶…å‡ºå®¹é‡ï¼‰
                if (!assigned) {
                    solution[0].push(customerId);
                }
            }
            
            return solution;
        }

        // è®¡ç®—è§£çš„æˆæœ¬
        function calculateSolutionCost(solution) {
            let totalCost = 0;
            for (let route of solution) {
                if (route.length === 0) continue;
                
                let cost = 0;
                let prev = getCustomerById(0); // ä»“åº“
                for (let customerId of route) {
                    let customer = getCustomerById(customerId);
                    cost += distance(prev, customer);
                    prev = customer;
                }
                cost += distance(prev, getCustomerById(0)); // å›åˆ°ä»“åº“
                totalCost += cost;
            }
            return totalCost;
        }

        // æ£€æŸ¥è§£çš„å¯è¡Œæ€§ï¼ˆæ”¾å®½çº¦æŸï¼‰
        function isSolutionValid(solution) {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å®¢æˆ·éƒ½è¢«åˆ†é…
            const assignedCustomers = new Set();
            for (let route of solution) {
                for (let customerId of route) {
                    assignedCustomers.add(customerId);
                }
            }
            
            const allCustomerIds = customers.filter(c => c.id !== 0).map(c => c.id);
            const allAssigned = allCustomerIds.every(id => assignedCustomers.has(id));
            
            if (!allAssigned) {
                return false;
            }
            
            // å®¹é‡çº¦æŸæ£€æŸ¥ï¼ˆå…è®¸è¶…å‡ºï¼Œä½†è®°å½•æƒ©ç½šï¼‰
            let totalPenalty = 0;
            for (let route of solution) {
                let totalDemand = 0;
                for (let customerId of route) {
                    totalDemand += getCustomerById(customerId).demand;
                }
                if (totalDemand > vehicleCapacity) {
                    totalPenalty += (totalDemand - vehicleCapacity) * 10; // å®¹é‡è¶…å‡ºæƒ©ç½š
                }
            }
            
            // å³ä½¿æœ‰å®¹é‡è¶…å‡ºï¼Œä¹Ÿè®¤ä¸ºæ˜¯"æœ‰æ•ˆ"çš„ï¼Œä½†æˆæœ¬ä¼šæ›´é«˜
            return true;
        }

        // äº¤å‰æ“ä½œ
        function crossover(parent1, parent2) {
            const child = Array(parent1.length).fill().map(() => []);
            const usedCustomers = new Set();
            
            // ä»çˆ¶ä»£1å¤åˆ¶éƒ¨åˆ†è·¯å¾„
            for (let i = 0; i < parent1.length; i++) {
                if (Math.random() < 0.6 && parent1[i].length > 0) {
                    child[i] = [...parent1[i]];
                    parent1[i].forEach(id => usedCustomers.add(id));
                }
            }
            
            // ä»çˆ¶ä»£2ä¸­è¡¥å……æœªä½¿ç”¨çš„å®¢æˆ·
            for (let route of parent2) {
                for (let customerId of route) {
                    if (!usedCustomers.has(customerId)) {
                        // æ‰¾åˆ°å®¹é‡æœ€å°‘çš„è½¦è¾†
                        let minDemand = Infinity;
                        let targetVehicle = 0;
                        
                        for (let i = 0; i < child.length; i++) {
                            const currentDemand = child[i].reduce((sum, id) => sum + getCustomerById(id).demand, 0);
                            if (currentDemand < minDemand) {
                                minDemand = currentDemand;
                                targetVehicle = i;
                            }
                        }
                        
                        child[targetVehicle].push(customerId);
                        usedCustomers.add(customerId);
                    }
                }
            }
            
            return child;
        }

        // å˜å¼‚æ“ä½œ
        function mutate(solution) {
            const mutated = solution.map(route => [...route]);
            
            for (let i = 0; i < mutated.length; i++) {
                if (Math.random() < mutationRate && mutated[i].length > 0) {
                    // éšæœºäº¤æ¢ä¸¤ä¸ªå®¢æˆ·
                    if (mutated[i].length > 1) {
                        const idx1 = Math.floor(Math.random() * mutated[i].length);
                        const idx2 = Math.floor(Math.random() * mutated[i].length);
                        if (idx1 !== idx2) {
                            [mutated[i][idx1], mutated[i][idx2]] = [mutated[i][idx2], mutated[i][idx1]];
                        }
                    }
                    
                    // éšæœºå°†å®¢æˆ·ç§»åŠ¨åˆ°å…¶ä»–è½¦è¾†
                    if (Math.random() < 0.3 && mutated[i].length > 0) {
                        const customerId = mutated[i].pop();
                        const targetVehicle = Math.floor(Math.random() * mutated.length);
                        mutated[targetVehicle].push(customerId);
                    }
                }
            }
            
            return mutated;
        }

        // è¿è¡Œé—ä¼ ç®—æ³•
        function runGeneticAlgorithm() {
            if (gaRunning) return;
            
            console.log('å¼€å§‹è¿è¡Œé—ä¼ ç®—æ³•...');
            
            // è·å–å‚æ•°
            const vehicleNum = parseInt(document.getElementById('gaVehicleNum').value);
            populationSize = parseInt(document.getElementById('populationSize').value);
            generations = parseInt(document.getElementById('generations').value);
            mutationRate = parseFloat(document.getElementById('mutationRate').value);
            maxRunTime = parseInt(document.getElementById('maxRunTime').value) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
            
            console.log('å‚æ•°:', { vehicleNum, populationSize, generations, mutationRate, maxRunTime });
            
            if (isNaN(vehicleNum) || vehicleNum < 1) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„è½¦è¾†æ•°é‡ï¼");
                return;
            }
            
            try {
                // åˆå§‹åŒ–
                gaRunning = true;
                currentGeneration = 0;
                bestCost = Infinity;
                bestSolution = null;
                startTime = Date.now();
                
                console.log('å¼€å§‹ç”Ÿæˆåˆå§‹ç§ç¾¤...');
                
                // ç”Ÿæˆåˆå§‹ç§ç¾¤
                population = [];
                for (let i = 0; i < populationSize; i++) {
                    let solution;
                    
                    // ä½¿ç”¨ç®€åŒ–çš„åˆå§‹è§£ç”Ÿæˆæ–¹æ³•
                    const customerIds = customers.filter(c => c.id !== 0).map(c => c.id);
                    solution = Array(vehicleNum).fill().map(() => []);
                    
                    // ç®€å•åˆ†é…ï¼Œå…è®¸è¶…å‡ºå®¹é‡
                    let vehicleIndex = 0;
                    for (let customerId of customerIds) {
                        solution[vehicleIndex % vehicleNum].push(customerId);
                        vehicleIndex++;
                    }
                    
                    population.push(solution);
                }
                
                console.log('åˆå§‹ç§ç¾¤ç”Ÿæˆå®Œæˆï¼Œç§ç¾¤å¤§å°:', population.length);
                console.log('ç¬¬ä¸€ä¸ªè§£ç¤ºä¾‹:', population[0]);
                
                // éªŒè¯åˆå§‹ç§ç¾¤
                if (population.length === 0) {
                    throw new Error('åˆå§‹ç§ç¾¤ç”Ÿæˆå¤±è´¥');
                }
                
                // è®¡ç®—åˆå§‹æœ€ä½³è§£
                const initialFitness = population.map(solution => ({
                    solution: solution,
                    cost: calculateSolutionCost(solution),
                    valid: isSolutionValid(solution)
                }));
                initialFitness.sort((a, b) => a.cost - b.cost);
                bestCost = initialFitness[0].cost;
                bestSolution = initialFitness[0].solution;
                console.log('åˆå§‹æœ€ä½³è§£æˆæœ¬:', bestCost);
                
                // æ›´æ–°UI
                document.getElementById('runGA').disabled = true;
                document.getElementById('stopGA').disabled = false;
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('bestCost').textContent = bestCost.toFixed(2);
                
                // å¼€å§‹è¿­ä»£
                gaInterval = setInterval(() => {
                    try {
                        // æ£€æŸ¥è¶…æ—¶
                        if (Date.now() - startTime > maxRunTime) {
                            console.log('é—ä¼ ç®—æ³•è¶…æ—¶ï¼Œè‡ªåŠ¨åœæ­¢');
                            stopGeneticAlgorithm();
                            return;
                        }
                        
                        if (currentGeneration >= generations || !gaRunning) {
                            stopGeneticAlgorithm();
                            return;
                        }
                        
                        // è¯„ä¼°ç§ç¾¤
                        const fitness = population.map(solution => ({
                            solution: solution,
                            cost: calculateSolutionCost(solution),
                            valid: isSolutionValid(solution)
                        }));
                        
                        // æ’åºï¼ˆæˆæœ¬è¶Šä½è¶Šå¥½ï¼‰
                        fitness.sort((a, b) => a.cost - b.cost);
                        
                        // æ›´æ–°æœ€ä½³è§£
                        if (fitness[0].cost < bestCost) {
                            bestCost = fitness[0].cost;
                            bestSolution = fitness[0].solution;
                            console.log('å‘ç°æ–°çš„æœ€ä½³è§£ï¼Œæˆæœ¬:', bestCost);
                        }
                        
                        // é€‰æ‹©ç²¾è‹±
                        const eliteSize = Math.max(1, Math.floor(populationSize * 0.1));
                        const elite = fitness.slice(0, eliteSize).map(f => f.solution);
                        
                        // ç”Ÿæˆæ–°ç§ç¾¤
                        const newPopulation = [...elite];
                        
                        // ç”Ÿæˆæ–°ä¸ªä½“
                        while (newPopulation.length < populationSize) {
                            const parent1 = fitness[Math.floor(Math.random() * fitness.length)].solution;
                            const parent2 = fitness[Math.floor(Math.random() * fitness.length)].solution;
                            
                            let child = crossover(parent1, parent2);
                            child = mutate(child);
                            
                            newPopulation.push(child);
                        }
                        
                        population = newPopulation;
                        currentGeneration++;
                        
                        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                        if (currentGeneration % 10 === 0) {
                            console.log(`ç¬¬${currentGeneration}ä»£å®Œæˆï¼Œç§ç¾¤å¤§å°: ${population.length}, æœ€ä½³æˆæœ¬: ${bestCost.toFixed(2)}`);
                        }
                        
                        // æ›´æ–°UI
                        updateGAUI();
                        
                    } catch (error) {
                        console.error('é—ä¼ ç®—æ³•è¿­ä»£é”™è¯¯:', error);
                        stopGeneticAlgorithm();
                    }
                    
                }, 100); // æ¯100msæ›´æ–°ä¸€æ¬¡
                
            } catch (error) {
                console.error('é—ä¼ ç®—æ³•åˆå§‹åŒ–é”™è¯¯:', error);
                alert('é—ä¼ ç®—æ³•åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                gaRunning = false;
                document.getElementById('runGA').disabled = false;
                document.getElementById('stopGA').disabled = true;
            }
        }

        // åœæ­¢é—ä¼ ç®—æ³•
        function stopGeneticAlgorithm() {
            gaRunning = false;
            if (gaInterval) {
                clearInterval(gaInterval);
                gaInterval = null;
            }
            
            document.getElementById('runGA').disabled = false;
            document.getElementById('stopGA').disabled = true;
            
            // ç»˜åˆ¶æœ€ä½³è§£
            if (bestSolution) {
                drawGASolution(bestSolution);
                // å¯ç”¨å¯¼å…¥æŒ‰é’®
                document.getElementById('importBtn').disabled = false;
            }
        }

        // é‡ç½®é—ä¼ ç®—æ³•
        function resetGA() {
            stopGeneticAlgorithm();
            currentGeneration = 0;
            bestCost = Infinity;
            bestSolution = null;
            
            document.getElementById('currentGen').textContent = '0';
            document.getElementById('bestCost').textContent = '-';
            document.getElementById('avgCost').textContent = '-';
            document.getElementById('timeElapsed').textContent = '0s';
            document.getElementById('progressFill').style.width = '0%';
            
            const canvas = document.getElementById('canvas-right');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            document.getElementById('cost-right').innerText = '';
            
            // éšè—è·¯å¾„æ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('gaRoutesDisplay').style.display = 'none';
            
            // ç¦ç”¨å¯¼å…¥æŒ‰é’®
            document.getElementById('importBtn').disabled = true;
        }

        // æµ‹è¯•é—ä¼ ç®—æ³•å‡½æ•°
        function testGeneticAlgorithm() {
            console.log('=== é—ä¼ ç®—æ³•æµ‹è¯•å¼€å§‹ ===');
            
            // æµ‹è¯•åŸºæœ¬å‡½æ•°
            console.log('1. æµ‹è¯•åŸºæœ¬å‡½æ•°:');
            console.log('- getCustomerById(1):', getCustomerById(1));
            console.log('- distanceå‡½æ•°:', distance(getCustomerById(0), getCustomerById(1)));
            
            // æµ‹è¯•è§£ç”Ÿæˆ
            console.log('2. æµ‹è¯•è§£ç”Ÿæˆ:');
            const testSolution = generateRandomSolution(3);
            console.log('- éšæœºè§£:', testSolution);
            console.log('- è§£æˆæœ¬:', calculateSolutionCost(testSolution));
            console.log('- è§£æœ‰æ•ˆæ€§:', isSolutionValid(testSolution));
            
            // æµ‹è¯•äº¤å‰å’Œå˜å¼‚
            console.log('3. æµ‹è¯•é—ä¼ æ“ä½œ:');
            const parent1 = generateRandomSolution(3);
            const parent2 = generateRandomSolution(3);
            console.log('- çˆ¶ä»£1:', parent1);
            console.log('- çˆ¶ä»£2:', parent2);
            
            const child = crossover(parent1, parent2);
            console.log('- äº¤å‰å:', child);
            
            const mutated = mutate(child);
            console.log('- å˜å¼‚å:', mutated);
            
            // æµ‹è¯•ç§ç¾¤ç”Ÿæˆ
            console.log('4. æµ‹è¯•ç§ç¾¤ç”Ÿæˆ:');
            const testPopulation = [];
            for (let i = 0; i < 5; i++) {
                testPopulation.push(generateRandomSolution(3));
            }
            console.log('- æµ‹è¯•ç§ç¾¤å¤§å°:', testPopulation.length);
            console.log('- ç§ç¾¤æˆæœ¬èŒƒå›´:', testPopulation.map(s => calculateSolutionCost(s)));
            
            console.log('=== é—ä¼ ç®—æ³•æµ‹è¯•å®Œæˆ ===');
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            alert(`æµ‹è¯•å®Œæˆï¼\n- éšæœºè§£ç”Ÿæˆ: ${testSolution.length > 0 ? 'æˆåŠŸ' : 'å¤±è´¥'}\n- è§£æˆæœ¬è®¡ç®—: ${calculateSolutionCost(testSolution).toFixed(2)}\n- ç§ç¾¤ç”Ÿæˆ: ${testPopulation.length}ä¸ªè§£\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚`);
        }

        // æ›´æ–°é—ä¼ ç®—æ³•UI
        function updateGAUI() {
            document.getElementById('currentGen').textContent = currentGeneration;
            document.getElementById('bestCost').textContent = bestCost.toFixed(2);
            
            // è®¡ç®—å¹³å‡æˆæœ¬
            const avgCost = population.reduce((sum, solution) => sum + calculateSolutionCost(solution), 0) / population.length;
            document.getElementById('avgCost').textContent = avgCost.toFixed(2);
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = (currentGeneration / generations) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // æ›´æ–°è¿è¡Œæ—¶é—´
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timeElapsed').textContent = elapsed + 's';
        }

        // ç»˜åˆ¶é—ä¼ ç®—æ³•è§£
        function drawGASolution(solution) {
            const canvas = document.getElementById('canvas-right');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç”»ç‚¹
            for (let c of customers) {
                ctx.beginPath();
                ctx.arc(c.x/1.2, c.y/1.2, 8, 0, 2 * Math.PI);
                ctx.fillStyle = c.id === 0 ? "#ff6600" : "#3399ff";
                ctx.fill();
                ctx.strokeStyle = "#333";
                ctx.stroke();
                ctx.font = "12px Arial";
                ctx.fillStyle = "#000";
                ctx.fillText(`${c.id}`, c.x/1.2 + 10, c.y/1.2 + 4);
            }

            // ç”»è·¯å¾„
            const colors = ["#e91e63", "#2196f3", "#4caf50", "#ff9800", "#9c27b0", "#009688", "#795548", "#607d8b", "#f44336", "#3f51b5"];
            let totalCost = 0;
            
            for (let i = 0; i < solution.length; i++) {
                const route = solution[i];
                if (route.length === 0) continue;
                
                ctx.strokeStyle = colors[i % colors.length];
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                // ä»“åº“å‡ºå‘
                let start = getCustomerById(0);
                ctx.moveTo(start.x/1.2, start.y/1.2);
                
                for (let id of route) {
                    let c = getCustomerById(id);
                    ctx.lineTo(c.x/1.2, c.y/1.2);
                }
                
                // å›åˆ°ä»“åº“
                ctx.lineTo(start.x/1.2, start.y/1.2);
                ctx.stroke();

                // è®¡ç®—æˆæœ¬
                let cost = 0;
                let prev = getCustomerById(0);
                for (let id of route) {
                    let c = getCustomerById(id);
                    cost += distance(prev, c);
                    prev = c;
                }
                cost += distance(prev, getCustomerById(0));
                totalCost += cost;

                // æ ‡æ³¨è½¦è¾†ç¼–å·
                if (route.length > 0) {
                    let midIdx = Math.floor(route.length / 2);
                    let midC = getCustomerById(route[midIdx]);
                    ctx.font = "bold 14px Arial";
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.fillText(`è½¦è¾†${i+1}`, midC.x/1.2 + 15, midC.y/1.2 - 10);
                }
            }

            // æ˜¾ç¤ºæˆæœ¬
            let costMsg = `é—ä¼ ç®—æ³•æœ€ä½³è§£ - æ€»è·¯å¾„æˆæœ¬ï¼š${totalCost.toFixed(2)}`;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶…å‡ºå®¹é‡çš„è½¦è¾†
            let hasOverCapacity = false;
            for (let route of solution) {
                const routeDemand = route.reduce((sum, id) => sum + getCustomerById(id).demand, 0);
                if (routeDemand > vehicleCapacity) {
                    hasOverCapacity = true;
                    break;
                }
            }
            
            if (hasOverCapacity) {
                costMsg += " âš ï¸ï¼ˆå­˜åœ¨è¶…å‡ºå®¹é‡é™åˆ¶çš„è½¦è¾†ï¼‰";
            } else {
                costMsg += " âœ…ï¼ˆæ‰€æœ‰è½¦è¾†éƒ½åœ¨å®¹é‡èŒƒå›´å†…ï¼‰";
            }
            
            document.getElementById('cost-right').innerText = costMsg;
            
            // æ˜¾ç¤ºè·¯å¾„è¯¦æƒ…
            displayGARoutes(solution);
        }
        
        // æ˜¾ç¤ºé—ä¼ ç®—æ³•è·¯å¾„è¯¦æƒ…
        function displayGARoutes(solution) {
            const routesDisplay = document.getElementById('gaRoutesDisplay');
            const routesInfo = document.getElementById('gaRoutesInfo');
            
            if (!solution || solution.length === 0) {
                routesDisplay.style.display = 'none';
                return;
            }
            
            let routesHtml = '';
            let totalDemand = 0;
            let hasOverCapacity = false;
            
            for (let i = 0; i < solution.length; i++) {
                const route = solution[i];
                if (route.length === 0) continue;
                
                const routeDemand = route.reduce((sum, id) => sum + getCustomerById(id).demand, 0);
                totalDemand += routeDemand;
                const isOverCapacity = routeDemand > vehicleCapacity;
                if (isOverCapacity) hasOverCapacity = true;
                
                const bgColor = isOverCapacity ? '#ffebee' : '#e3f2fd';
                const borderColor = isOverCapacity ? '#f44336' : '#2196f3';
                const textColor = isOverCapacity ? '#d32f2f' : '#1976d2';
                
                routesHtml += `<div style="margin: 5px 0; padding: 8px; background: ${bgColor}; border-radius: 4px; border-left: 3px solid ${borderColor};">
                    <div style="font-weight: bold; color: ${textColor}; margin-bottom: 3px;">
                        ğŸšš è½¦è¾†${i+1} ${isOverCapacity ? 'âš ï¸ è¶…å‡ºå®¹é‡' : ''}
                    </div>
                    <div style="color: #333; margin-bottom: 3px;"><strong>è·¯å¾„:</strong> ${route.join(' â†’ ')}</div>
                    <div style="color: #666; font-size: 11px;">
                        éœ€æ±‚: ${routeDemand} | å®¹é‡: ${vehicleCapacity} | åˆ©ç”¨ç‡: ${((routeDemand/vehicleCapacity)*100).toFixed(1)}%
                        ${isOverCapacity ? ' | <span style="color: #f44336; font-weight: bold;">è¶…å‡º: ' + (routeDemand - vehicleCapacity) + '</span>' : ''}
                    </div>
                </div>`;
            }
            
            const summaryBgColor = hasOverCapacity ? '#ffebee' : '#c8e6c9';
            const summaryBorderColor = hasOverCapacity ? '#f44336' : '#4caf50';
            
            routesHtml += `<div style="margin-top: 10px; padding: 5px; background: ${summaryBgColor}; border-radius: 3px; font-weight: bold; border-left: 3px solid ${summaryBorderColor};">
                æ€»éœ€æ±‚: ${totalDemand} | æ€»æˆæœ¬: ${calculateSolutionCost(solution).toFixed(2)}
                ${hasOverCapacity ? ' | âš ï¸ å­˜åœ¨è¶…å‡ºå®¹é‡çš„è½¦è¾†' : ' | âœ… æ‰€æœ‰è½¦è¾†éƒ½åœ¨å®¹é‡èŒƒå›´å†…'}
            </div>`;
            
            routesInfo.innerHTML = routesHtml;
            routesDisplay.style.display = 'block';
        }
        
        // å°†é—ä¼ ç®—æ³•è§£å¯¼å…¥åˆ°å·¦ä¾§æ‰‹åŠ¨è¾“å…¥æ¡†
        function importGASolution() {
            if (!bestSolution) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„é—ä¼ ç®—æ³•è§£ï¼');
                return;
            }
            
            // æ£€æŸ¥å·¦ä¾§è½¦è¾†æ•°é‡æ˜¯å¦åŒ¹é…
            const leftVehicleNum = parseInt(document.getElementById('vehicleNum').value);
            if (leftVehicleNum !== bestSolution.length) {
                if (!confirm(`å·¦ä¾§è½¦è¾†æ•°é‡(${leftVehicleNum})ä¸é—ä¼ ç®—æ³•è§£(${bestSolution.length})ä¸åŒ¹é…ï¼Œæ˜¯å¦è°ƒæ•´å·¦ä¾§è½¦è¾†æ•°é‡ï¼Ÿ`)) {
                    return;
                }
                document.getElementById('vehicleNum').value = bestSolution.length;
                generateTable();
            }
            
            // æ¸…ç©ºç°æœ‰è¾“å…¥å¹¶é‡æ–°ç”Ÿæˆè¶³å¤Ÿçš„æ–¹æ ¼
            for (let i = 0; i < bestSolution.length; i++) {
                const route = bestSolution[i];
                
                // ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ–¹æ ¼
                while (vehicleCellCounts[i] < route.length) {
                    vehicleCellCounts[i]++;
                    const gridDiv = document.getElementById(`customerGrid${i}`);
                    const newInput = document.createElement('input');
                    newInput.type = "text";
                    newInput.maxLength = 2;
                    newInput.className = "customer-cell";
                    newInput.id = `cell_${i}_${vehicleCellCounts[i]-1}`;
                    newInput.setAttribute("oninput", `onCellInput(${i}, ${vehicleCellCounts[i]-1})`);
                    newInput.setAttribute("onkeydown", `onCellKeyDown(event, ${i}, ${vehicleCellCounts[i]-1})`);
                    newInput.setAttribute("autocomplete", "off");
                    gridDiv.appendChild(newInput);
                }
                
                // å¡«å……å®¢æˆ·ç¼–å·
                for (let j = 0; j < route.length; j++) {
                    const cell = document.getElementById(`cell_${i}_${j}`);
                    if (cell) {
                        cell.value = route[j];
                        cell.classList.remove('cell-invalid');
                    }
                }
                
                // æ¸…ç©ºå¤šä½™çš„æ–¹æ ¼
                for (let j = route.length; j < vehicleCellCounts[i]; j++) {
                    const cell = document.getElementById(`cell_${i}_${j}`);
                    if (cell) {
                        cell.value = '';
                        cell.classList.remove('cell-invalid');
                    }
                }
                
                updateDemand(i);
            }
            
            // é‡æ–°ç»˜åˆ¶å·¦ä¾§å›¾è¡¨
            drawCVRP();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('é—ä¼ ç®—æ³•è§£å·²æˆåŠŸå¯¼å…¥åˆ°å·¦ä¾§æ‰‹åŠ¨è¾“å…¥æ¡†ï¼');
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨ç”Ÿæˆè¡¨æ ¼å’Œæ¼”ç¤º
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
            const runGAButton = document.getElementById('runGA');
            const stopGAButton = document.getElementById('stopGA');
            const importBtn = document.getElementById('importBtn');
            
            console.log('DOMå…ƒç´ æ£€æŸ¥:', {
                runGAButton: !!runGAButton,
                stopGAButton: !!stopGAButton,
                importBtn: !!importBtn
            });
            
            // æ£€æŸ¥é—ä¼ ç®—æ³•å‡½æ•°æ˜¯å¦æ­£ç¡®å®šä¹‰
            console.log('å‡½æ•°æ£€æŸ¥:', {
                runGeneticAlgorithm: typeof runGeneticAlgorithm,
                stopGeneticAlgorithm: typeof stopGeneticAlgorithm,
                generateRandomSolution: typeof generateRandomSolution,
                isSolutionValid: typeof isSolutionValid
            });
            
            document.getElementById('vehicleNum').value = 3;
            document.getElementById('gaVehicleNum').value = 3;
            document.getElementById('maxRunTime').value = 30;
            
            // ç¡®ä¿å¯¼å…¥æŒ‰é’®åˆå§‹çŠ¶æ€æ˜¯ç¦ç”¨çš„
            document.getElementById('importBtn').disabled = true;
            
            generateTable();
            
            // é»˜è®¤åˆ†é…ï¼ˆé€‚åº”30ä¸ªå®¢æˆ·ç‚¹ï¼‰
            let defaultData = [
                [1,2,3,4,5,6,7,8,9,10],
                [11,12,13,14,15,16,17,18,19,20],
                [21,22,23,24,25,26,27,28,29,30]
            ];
            for (let i = 0; i < defaultData.length; i++) {
                for (let j = 0; j < defaultData[i].length; j++) {
                    let cell = document.getElementById(`cell_${i}_${j}`);
                    if (cell) {
                        cell.value = defaultData[i][j];
                    }
                }
                updateDemand(i);
            }
            drawCVRP();
            
            // è®¾ç½®ç”»å¸ƒç¼©æ”¾å’Œæ‹–æ‹½åŠŸèƒ½
            setupCanvasInteraction('left');
            setupCanvasInteraction('right');
            
            console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            
            // è‡ªåŠ¨æµ‹è¯•é—ä¼ ç®—æ³•åŸºæœ¬åŠŸèƒ½
            setTimeout(() => {
                console.log('å¼€å§‹è‡ªåŠ¨æµ‹è¯•é—ä¼ ç®—æ³•...');
                try {
                    const testSolution = generateRandomSolution(3);
                    console.log('è‡ªåŠ¨æµ‹è¯• - éšæœºè§£ç”ŸæˆæˆåŠŸ:', testSolution.length > 0);
                    console.log('è‡ªåŠ¨æµ‹è¯• - è§£æˆæœ¬:', calculateSolutionCost(testSolution));
                    
                    if (testSolution.length > 0) {
                        console.log('âœ… é—ä¼ ç®—æ³•åŸºæœ¬åŠŸèƒ½æ­£å¸¸');
                    } else {
                        console.log('âŒ é—ä¼ ç®—æ³•åŸºæœ¬åŠŸèƒ½å¼‚å¸¸');
                    }
                } catch (error) {
                    console.error('è‡ªåŠ¨æµ‹è¯•å¤±è´¥:', error);
                }
            }, 1000);
        }
    </script>
</body>
</html>

